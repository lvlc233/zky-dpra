# 项目规格文档
## 介绍
这是一个基于Langgraph的DeepAgent项目，该项目旨在利用强大的Agent编排，上下文工程和资源管理技术，为任意的研究人员提供更好的Agent服务，降低研究人员的研发过程中的心智负担，全身心的投入在有价值的内容产出中。


## 项目架构
### 后端
1. 3+1层架构: 
    - controller层: 
        1. 负责service层数据到web层数据的封装。
        2. 负责权限相关处理。
        3. 该层还负责定义请求相关的数据模型。
    - service层: 
        1. 负责核心数据合成
        2. 负责调度基础设施层: 包括redis,sql,neo4j等
    - 基础设置层:
        1. 提供相关基础设施的操作语句的封装。
    - 数据层:
        1. 该层仅存放数据模型而不进行任何的逻辑处理。
        2. 数据层的数据模型应从业务逻辑出发构建，并由于service层进行组装。

2. 安全
    - 使用PyJWT进行身份验证。
3. 在web层的所有数据模型统一使用Pydantic而非TypeDict
4. 使用fastApi的容器管理线程资源，并给予注入传递线程信息。


### Agent:
定义: 在本项目中，Agent指独立的一个已编译的图。
#### 状态
1. 任何的状态统一使用TypeDict为基类，而非dataclass或BaseModel
2. 任何的状态都应该至少保留两个字段:
    "messages": 该字段用于面向用户的历史信息记录，任何情况下Agent的上下文不应该直接使用messages中的任意的数据，除非它经过处理或在其他字段中存储。
    "context":  该字段用于面向Agent的上下文信息，包括但不限于历史交互记录。该字段通常不是用户直接可以查询的内容。
3. 所有的Message都必须使用langchain的Messages类进行包装而不能直接使用字典{"role":"","message":""}
4. 必须备注状态中的所有字段的含义、作用，使用范围。
5. 当状态使用归约函数(特征是使用Anntion[type,func]进行标记的字段),则在处理状态时
6. 当一个字段需要在运行时候发生改变时，它应该是状态,如messages

#### 工具
1. 所有的工具都应该尽量功能内聚,并提供明确的工具调度实机，参数细节，预期返回结构，异常信息潜在情况。
2. 当工具信息需要更新状态时候，使用Command包装工具的返回值，并且在更新字段时必须至少携带{"messages": ToolMessages("工具调度的消息{自定义}",tool_call_id=tool_call_id)}
3. tool_call_id通过节点注入runtime:ToolRuntime,runtime.tool_call_id获取。
4. 所有的工具不论具体的逻辑是什么，在返回时至少需要更新模型的上下文状态，并传入信息工具的调用结果
5. 所有工具必须考虑异常情况的捕获和异常时的上下文处理

#### 模型上下文
1. 所有的上下文都必须携带时间信息
2. 上下文数据的封装必须在调度模型的节点处进行动态的拼装，所有非自然语言数据结构(如 类等)必须转化为自然语言或带有数据格式(如.md...)的上下文信息。
3. 当上下文数据中携带字段时，不论什么情况都应该对字段进行含义的解释后，传入上下文。
4. 当上下文中存在对话历史记录等，必须将消息明确的区分为 用户: "" | 时间,Agent_name: "" | 时间
5. 所有的上下文必须明确当前处理的Agent是什么Agent，所属任务是什么。

#### 静态上下文 与 config配置
1. 所有的静态上下文仅可以使用可序列化数据模型，而不应该在静态上下文中存储不可序列化的数据,例如: client_session_id: ok,clinet: can`t 
2. 如果需要将不可以序列化实例传入节点或工具内部，应该使用config进行注入和获取。
3. 当一个字段不需要在运行时候发生改变时，它应该是静态上下文: 如user_id


#### 记忆
1. Agent的长期记忆部分由节点的store注入获取。

#### 节点
1. 所有的节点返回时候使用字典的方式进行所需状态字段的更新，而非返回一个状态对象。 
2. 所有节点必须考虑异常情况的捕获和异常时的上下文处理
3. 使用Command进行节点跳转时,必须使用Literal[...],约束跳转目标节点。在add_node中设置ends,用于辅助美人鱼图生成。

#### 输出
1. 图的输出使用astream监听事件
2. 可监听类型为:token,tool和自定义。
3. 使用from langgraph.config import get_stream_writer 获取写入器进行自定义的事件写入。

#### 人工介入
当存在需要人工介入时逻辑时，如内容审核、外部状态注入，进行以下分析
1. 强人工介入，图的数据必须由于Human进行数据的输入或确定后才可以进行后续流程时，使用interrupt函数进行中断抛出，注意langgraph的中断恢复后将从节点从重新执行而非在中断函数处继续。
2. 强人工介入需要返回相关的语句提示，并在接收端至少包括一个用户输入内容，用于人类进行自然语言的任务编排。
3. 弱人工介入, 需要人工介入的数据不影响图的正常运行，例如一些待办事项、todo列表。使用时候不基于interrupt函数进行中断，而是在状态中建立一个代办项管道。用户可以通过Command操作更新管道数据。从而进行人工介入。

#### 测试
Agent测试内容包括3个部分，并以节点和工具为单位。
1. 单节点或工具功能性测试:
使用pytest对节点的输入输出测试，使用mock数据校验节点的输入数据，输出数据，和内部数据状态，使其完全符合节点内的功能和实现描述。
2. 模型测试:
- 当一个节点包含LLM时，应该对其进行模型的测试，需要分析在节点内容潜在上下文状态，并创建可能的上下文数据(包括工具结果)，对不同的上下文数据进行实际的LLM调用，以确保其最终的实际输出结果符合大致预取。
- 模型的测试中所有需要获取转化为上下文的数据都可以进行mock，但是模型的输出不可以mokc
- 使用langfuse进行链路追踪
- 在生成潜在上下文时，标注测试节点、测试内容、预期结果。并将其封装为数据集的一部分。
- 模型测试包含功能性测试和规格性测试: 规格性测试表示模型需要输出符合实际描述的数据结构，这通常可以使用断言判断，功能性测试是指模型的输出最终要符合要求，例如指令遵循程度，抗干扰程度，通常使用一个审核Agent或人类进行打分。
3. 级联测试，
- 基于实际可能的交互过程，对Agent进行非mock数据的全面测试。
- 需创建数据集
- 使用langfuse进行链路追踪


### 前端
1. 使用config专门处理url连接等配置项
2. 使用专门的service进行后端数据连接并进行数据转化
TODO: 前端内容不了解，需要一定的调研。



## 技术栈总览

> 基于 `uv` 构建的 AI 文档知识库项目一站式技术清单

---

### 1. 后端
| 组件 | 版本/说明 | 作用 |
|---|---|---|
| Python | ≥3.12.x | 主语言 |
| uv | latest | 包管理 + 虚拟环境 + 构建（替代 pip/poetry） |
| FastAPI | latest | 异步 Web 框架，自动生成 Swagger |
| Uvicorn | latest | ASGI 服务器 |
| sse-starlette | latest | SSE 流式输出 |
| psycopg2-binary | latest | PostgreSQL 驱动 |
| sqlmodel | latest | ORM，与 Pydantic 无缝集成 |
| PyJWT | latest | JWT 签发/校验 |
| httpx | latest | 异步 HTTP 客户端 |
| Python logging | stdlib | 统一日志格式：时间戳｜输入｜输出｜异常 |

---

### 2. 前端
| 组件 | 版本/说明 | 作用 |
|---|---|---|
| React + Next.js | latest | SSR/SSG、文件式路由、全栈一体 |
| React PDF | latest | 前端 PDF 阅读器，支持标注与高亮 |

---

### 3. AI / ML
| 组件 | 版本/说明 | 作用 |
|---|---|---|
| LangChain | ≥1.1.0 | LLM 编排：Chain、Memory、Tool |
| LangGraph | ≥1.0.0 | 图结构多 Agent 工作流 |
| SiliconFlow | — | 大模型运营商，统一 OpenAI-Compatible API |
| DeepSeek-OCR | siliconflow 模型 | 扫描件文字识别 |
| Google Translate API | — | 过渡版翻译模块 |

---

### 4. 数据与检索
| 组件 | 版本/说明 | 作用 |
|---|---|---|
| PostgreSQL | ≥15 | 主关系型数据库 |
| Redis | 7.x | 缓存、分布式锁、SSE 会话 |
| Neo4j | latest | 图数据库，知识图谱 |
| Whoosh + Jieba | latest | 纯 Python 全文检索 + 中文分词 |

---

### 5. 基础设施
| 组件 | 版本/说明 | 作用 |
|---|---|---|
| MinIO | latest | 兼容 S3 的对象存储（PDF/图片/模型） |
| Docker | — | 容器化部署 |

---

### 6. 工具链
| 组件 | 版本/说明 | 作用 |
|---|---|---|
| uv | latest | 极速依赖管理、构建、发布 |
| Ruff | latest | Rust 级代码检查/格式化 |
| Git + GitHub Actions | — | CI/CD，可复现构建（基于 `uv.lock`） |

---

## 代码编写规范
1. 所有的功能模块都应该使用日志
2. 所有的代码模块都必须记录完整的日记，
3. 设置时间区域为中国上海
4. 当一个非业务逻辑的函数或相似的逻辑被构建超过3次，那么它应该考虑合并为通用的工具，例如获取当前的中国时区时间。
5. 项目中所有的数据必须标注好其返回的数据类型。
6. 在一个功能没有经过测试验证后，必须始终保持TODO的状态，
7. 禁止使用任何的模拟数据用于暂时替代代码逻辑。若表示需要更加明确的逻辑，则使用TODO进行位置标注，并附加需求。
8. 所有人编写代码时候必须附加上以下数据格式的注释，否则将被视为不符合规范
    '''
    开发者: agent_name/ human_name
    当前版本: 任何一个在该模块不重复的标记
    创建时间: 使用YYYY-MM-DD格式,Agent使用Time工具获取当前时间
    更新时间: 使用YYYY-MM-DD格式,Agent使用Time工具获取当前时间
    更新记录: 
        [开发时间:开发版本:用一句话大概描述下输入,输出,效果,实现,可以在什么地方使用?]
    '''
9. 如果一个模块打算废弃，使用 废弃的注解标志，并提交废弃申请记录，供MasterAgent或人类审核。 
10. 后端项目始终使用模块化导包而非相对位置导包，若不清楚模块内容，查看pyproject.toml

## 代码结构
\main
└── backend/                                  # 后端（基于 FastAPI + Python）
    ├── .env                                  # 环境变量（未开始）
    ├── .env.template                         # 环境变量模板（未开始）
    ├── .python-version                       # Python 版本约束（未开始）
    ├── pyproject.toml                        # Python 项目依赖/构建配置（未开始）
    ├── main.py                               # 后端入口文件（未开始）
    ├── README.md                             # 后端说明文档（未完成）
    ├── dataset/                              # 数据集（用于 Agent 评估评测；未开始）
    │   └── README.md                         # 数据集说明（评估评测数据存放处：尚未开始搭建）
    ├── src/
    │   ├── agent/                            # Agent 层（基于 langgraph；每个 Agent 是一个图）
    │   │   ├── README.md                     # Agent 层开发流程与结构说明
    │   │   ├── common/                       # agent 领域下可复用代码
    │   │   │   └── tools.py                  # 可复用工具实现
    │   │   ├── example_agent/                # 示例 Agent（命名规则：{agent_name}）
    │   │   │   ├── __init__.py               # 按需暴露资源（一般只暴露 agent）
    │   │   │   ├── agent.py                  # 图路由规则 + 节点编排关系
    │   │   │   ├── node.py                   # 节点具体实现
    │   │   │   ├── prompts.py                # LLM prompts + 工具描述
    │   │   │   ├── schema.py                 # Agent 状态/运行上下文/结构化输出定义
    │   │   │   └── tools.py                  # 节点工具定义
    │   │   └── llm/                          # LLM 基础配置工厂（当前目录未落地）
    │   ├── base/
    │   │   ├── pg/                            # 关系型数据库层（SQLModel + PostgreSQL；state: TODO）
    │   │   │   ├── README.md                  # ORM/结构说明
    │   │   │   ├── entity.py                  # 数据库实体模型定义
    │   │   │   └── service.py                 # PG 数据库语句/访问服务
    │   │   ├── redis/                         # Redis 缓存层
    │   │   │   └── README.md
    │   │   └── neo4j/                         # Neo4j 图数据库层
    │   │       └── README.md
    │   ├── business_model/                    # 业务数据模型（模块化核心；必须使用 Pydantic）
    │   │   ├── README.md                      # 业务模型开发约束/组织方式说明文档 
    │   │   └── model.py                       # 业务模型实现
    │   ├── common/                            # 通用模块（utils 等通用、重复代码工具）
    │   │   ├── README.md                      # 通用工具说明（当前聚焦 utils）
    │   │   └── uitls.py                       # 通用工具实现
    │   ├── controller/                        # 控制器层（Web 层 controller）
    │   │   ├── README.md                      # Web 接口组织方式说明（“url 即模块路径”）
    │   │   ├── api/                           # Web 层 API 接口
    │   │   │   ├── app.py                     # API 应用入口/聚合
    │   │   │   └── example/
    │   │   │       └── module_name/           # 按模块组织：每个模块对应请求模型与路由逻辑
    │   │   │           ├── requests.py         # 请求模型
    │   │   │           └── router.py           # 路由逻辑
    │   │   ├── event.py                       # 流式输出相关配置
    │   │   ├── response.py                    # 通用非流式响应模型
    │   │   └── security/                      # 安全相关逻辑
    │   └── service/                           # 服务层（Web 层 service 逻辑）
    │       └── README.md
    └── test/
        ├── agent/                             # Agent 评估评测
        │   └── README.md                      # 评估评测开发流程说明（未完成）
        └── src/                               # 传统后端单元测试
            └── README.md




